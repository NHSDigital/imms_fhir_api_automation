name: Run e2e tests

on:
  push:
    branches: [ github-workflow ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Connect to AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: eu-west-2
          role-to-assume: arn:aws:iam::345594581768:role/auto-ops
          role-session-name: github-actions

      - name: Whoami
        run: aws sts get-caller-identity

      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          set -o pipefail

          echo "Creating virtual environment"
          python -m venv venv
          source venv/bin/activate

          echo "Upgrading pip"
          python -m pip install --upgrade pip 2> pip_error.log || {
            echo "Failed to upgrade pip"
            cat pip_error.log
            exit 1
          }

          echo "Installing requirements"
          pip install -r requirements.txt 2> req_error.log || {
            echo "Failed to install requirements.txt"
            cat req_error.log
            exit 1
          }

          pip install allure-pytest 2> allure_error.log || {
            echo "Failed to install allure-pytest"
            cat allure_error.log
            exit 1
          }      

      - name: Run Pytest-BDD tests
        continue-on-error: true
        env:
          auth_url: https://int.api.service.nhs.uk/oauth2-mock/authorize
          token_url: https://int.api.service.nhs.uk/oauth2-mock/token
          callback_url: https://oauth.pstmn.io/v1/callback
          Postman_Auth_client_Id: mNnjGa3dtSh7eKkMxkGjy3JXrAkvZW1s
          Postman_Auth_client_Secret: 2np7WP9Iz6NOKXMN
          username: aal3
          scope: nhs-cis2
          RAVS_client_Id: mKAFdGHvfAmRJIYCmrgvVAOms5X3gZiG
          RAVS_client_Secret: 8udIRfKfnFHZje3r
          MAVIS_client_Id: ZMFe92RMTQ7JntxAeOSe4ZlLmdlkBtnK
          MAVIS_client_Secret: IA9jmEHI04wKwH6C
          OPTUM_client_Id: hWAOPTqJLC2hjMEIC6Y5AiXyBBctSzrl
          OPTUM_client_Secret: FZIOoP8C9F8ng9Ht
          SONAR_client_Id: ooAGdMkVxkGDk3ioxT6nvmtopILi9A3u
          SONAR_client_Secret: bAgm21lNWITrFftY
          baseUrl: https://int.api.service.nhs.uk/immunisation-fhir-api/FHIR/R4
          aws_token_refresh: 'False'
        run: |
          echo "Activating virtual env"
          source venv/bin/activate

          echo "Running Pytest-BDD tests"
          pytest --junitxml=output/test-results.xml
          EXIT_CODE=$?

          echo "Pytest exit code: $EXIT_CODE"

          if [ $EXIT_CODE -ne 0 ]; then
            echo "::error::Pytest failed with exit code $EXIT_CODE"
          fi
      
      - name: Upload test results as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: BDD-Test-Results
          path: output/test-results.xml

      - name: Publish test results to GitHub UI
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: BDD Test Summary
          path: '**/output/test-results.xml'
          reporter: java-junit


