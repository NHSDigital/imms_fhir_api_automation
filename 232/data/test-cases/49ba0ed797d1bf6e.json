{"uid":"49ba0ed797d1bf6e","name":"verify that vaccination record will be successful if mandatory field for site, location and unique URI are invalid in batch file","fullName":"features.batchTests.Steps.test_create_batch_steps#test_verify_that_vaccination_record_will_be_successful_if_mandatory_field_for_site_location_and_unique_uri_are_invalid_in_batch_file","historyId":"98ca013b911b47beb8b2eb14bca97b4f","time":{"start":1768398061841,"stop":1768398120869,"duration":59028},"description":"/home/runner/work/imms_fhir_api_automation/imms_fhir_api_automation/features/batchTests/create_batch.feature: verify that vaccination record will be successful if mandatory field for site, location and unique URI are invalid in batch file","descriptionHtml":"<p>/home/runner/work/imms_fhir_api_automation/imms_fhir_api_automation/features/batchTests/create_batch.feature: verify that vaccination record will be successful if mandatory field for site, location and unique URI are invalid in batch file</p>\n","status":"failed","statusMessage":"AssertionError:  Failed to delete 73ab5639-ba46-42aa-bb62-59755fd2379b: expected 204, got 502. Response: {\"fault\":{\"faultstring\":\"Unexpected EOF at target\",\"detail\":{\"errorcode\":\"messaging.adaptors.http.flow.UnexpectedEOFAtTarget\"}}}\nassert 502 == 204\n +  where 502 = <Response [502]>.status_code","statusTrace":"self = <HookCaller 'pytest_bdd_after_scenario'>\nkwargs = {'feature': Feature(scenarios=OrderedDict([('Verify that full dataset vaccination record will be created through batch...background=None)], description='', tags={'vaccine_type_HIB', 'supplier_name_EMIS', 'delete_cleanup_batch'}, rule=None)}\nfirstresult = False\n\n    def __call__(self, **kwargs: object) -> Any:\n        \"\"\"Call the hook.\n    \n        Only accepts keyword arguments, which should match the hook\n        specification.\n    \n        Returns the result(s) of calling all registered plugins, see\n        :ref:`calling`.\n        \"\"\"\n        assert (\n            not self.is_historic()\n        ), \"Cannot directly call a historic hook - use call_historic instead.\"\n        self._verify_all_args_are_provided(kwargs)\n        firstresult = self.spec.opts.get(\"firstresult\", False) if self.spec else False\n        # Copy because plugins may register other plugins during iteration (#438).\n>       return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n\nvenv/lib/python3.11/site-packages/pluggy/_hooks.py:513: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.11/site-packages/pluggy/_manager.py:120: in _hookexec\n    return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nrequest = <FixtureRequest for <Function test_verify_that_vaccination_record_will_be_successful_if_mandatory_field_for_site_location_and_unique_uri_are_invalid_in_batch_file>>\nfeature = Feature(scenarios=OrderedDict([('Verify that full dataset vaccination record will be created through batch file', Scen...tient through batch file', tags={'Create_Batch_Feature', 'functional'}, background=None, line_number=2, description='')\nscenario = Scenario(feature=Feature(scenarios=OrderedDict([('Verify that full dataset vaccination record will be created through ... background=None)], description='', tags={'vaccine_type_HIB', 'supplier_name_EMIS', 'delete_cleanup_batch'}, rule=None)\n\n    def pytest_bdd_after_scenario(request, feature, scenario):\n        tags = set(getattr(scenario, 'tags', [])) | set(getattr(feature, 'tags', []))\n        context = request.getfixturevalue('context')\n        get_delete_url_header(context)\n    \n        if 'Delete_cleanUp' in tags:\n            if context.ImmsID is not None:\n                print(f\"\\n Delete Request is {context.url}/{context.ImmsID}\")\n                context.response = requests.delete(f\"{context.url}/{context.ImmsID}\", headers=context.headers)\n                assert context.response.status_code == 204, f\"Expected status code 204, but got {context.response.status_code}. Response: {context.response.json()}\"\n            else:\n                print(\"Skipping delete: ImmsID is None\")\n    \n    \n        if 'delete_cleanup_batch' in tags:\n            get_tokens(context, context.supplier_name)\n            context.vaccine_df[\"IMMS_ID_CLEAN\"] = context.vaccine_df[\"IMMS_ID\"].astype(str).str.replace(\"Immunization#\", \"\", regex=False)\n    \n            for imms_id in context.vaccine_df[\"IMMS_ID_CLEAN\"].dropna().unique():\n                delete_url = f\"{context.url}/{imms_id}\"\n                print(f\"Sending DELETE request to: {delete_url}\")\n                response = requests.delete(delete_url, headers=context.headers)\n    \n>               assert response.status_code == 204, (\n                    f\" Failed to delete {imms_id}: expected 204, got {response.status_code}. \"\n                    f\"Response: {response.text}\"\n                )\nE               AssertionError:  Failed to delete 73ab5639-ba46-42aa-bb62-59755fd2379b: expected 204, got 502. Response: {\"fault\":{\"faultstring\":\"Unexpected EOF at target\",\"detail\":{\"errorcode\":\"messaging.adaptors.http.flow.UnexpectedEOFAtTarget\"}}}\nE               assert 502 == 204\nE                +  where 502 = <Response [502]>.status_code\n\nfeatures/conftest.py:101: AssertionError","flaky":false,"newFailed":true,"newBroken":false,"newPassed":false,"retriesCount":0,"retriesStatusChange":false,"beforeStages":[{"name":"setup_environment","time":{"start":1768397610005,"stop":1768397610006,"duration":1},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"global_context","time":{"start":1768397610007,"stop":1768397611717,"duration":1710},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"_pytest_bdd_example","time":{"start":1768398061841,"stop":1768398061841,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"context","time":{"start":1768398061842,"stop":1768398063877,"duration":2035},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false}],"testStage":{"description":"/home/runner/work/imms_fhir_api_automation/imms_fhir_api_automation/features/batchTests/create_batch.feature: verify that vaccination record will be successful if mandatory field for site, location and unique URI are invalid in batch file","status":"failed","statusMessage":"AssertionError:  Failed to delete 73ab5639-ba46-42aa-bb62-59755fd2379b: expected 204, got 502. Response: {\"fault\":{\"faultstring\":\"Unexpected EOF at target\",\"detail\":{\"errorcode\":\"messaging.adaptors.http.flow.UnexpectedEOFAtTarget\"}}}\nassert 502 == 204\n +  where 502 = <Response [502]>.status_code","statusTrace":"self = <HookCaller 'pytest_bdd_after_scenario'>\nkwargs = {'feature': Feature(scenarios=OrderedDict([('Verify that full dataset vaccination record will be created through batch...background=None)], description='', tags={'vaccine_type_HIB', 'supplier_name_EMIS', 'delete_cleanup_batch'}, rule=None)}\nfirstresult = False\n\n    def __call__(self, **kwargs: object) -> Any:\n        \"\"\"Call the hook.\n    \n        Only accepts keyword arguments, which should match the hook\n        specification.\n    \n        Returns the result(s) of calling all registered plugins, see\n        :ref:`calling`.\n        \"\"\"\n        assert (\n            not self.is_historic()\n        ), \"Cannot directly call a historic hook - use call_historic instead.\"\n        self._verify_all_args_are_provided(kwargs)\n        firstresult = self.spec.opts.get(\"firstresult\", False) if self.spec else False\n        # Copy because plugins may register other plugins during iteration (#438).\n>       return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n\nvenv/lib/python3.11/site-packages/pluggy/_hooks.py:513: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nvenv/lib/python3.11/site-packages/pluggy/_manager.py:120: in _hookexec\n    return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nrequest = <FixtureRequest for <Function test_verify_that_vaccination_record_will_be_successful_if_mandatory_field_for_site_location_and_unique_uri_are_invalid_in_batch_file>>\nfeature = Feature(scenarios=OrderedDict([('Verify that full dataset vaccination record will be created through batch file', Scen...tient through batch file', tags={'Create_Batch_Feature', 'functional'}, background=None, line_number=2, description='')\nscenario = Scenario(feature=Feature(scenarios=OrderedDict([('Verify that full dataset vaccination record will be created through ... background=None)], description='', tags={'vaccine_type_HIB', 'supplier_name_EMIS', 'delete_cleanup_batch'}, rule=None)\n\n    def pytest_bdd_after_scenario(request, feature, scenario):\n        tags = set(getattr(scenario, 'tags', [])) | set(getattr(feature, 'tags', []))\n        context = request.getfixturevalue('context')\n        get_delete_url_header(context)\n    \n        if 'Delete_cleanUp' in tags:\n            if context.ImmsID is not None:\n                print(f\"\\n Delete Request is {context.url}/{context.ImmsID}\")\n                context.response = requests.delete(f\"{context.url}/{context.ImmsID}\", headers=context.headers)\n                assert context.response.status_code == 204, f\"Expected status code 204, but got {context.response.status_code}. Response: {context.response.json()}\"\n            else:\n                print(\"Skipping delete: ImmsID is None\")\n    \n    \n        if 'delete_cleanup_batch' in tags:\n            get_tokens(context, context.supplier_name)\n            context.vaccine_df[\"IMMS_ID_CLEAN\"] = context.vaccine_df[\"IMMS_ID\"].astype(str).str.replace(\"Immunization#\", \"\", regex=False)\n    \n            for imms_id in context.vaccine_df[\"IMMS_ID_CLEAN\"].dropna().unique():\n                delete_url = f\"{context.url}/{imms_id}\"\n                print(f\"Sending DELETE request to: {delete_url}\")\n                response = requests.delete(delete_url, headers=context.headers)\n    \n>               assert response.status_code == 204, (\n                    f\" Failed to delete {imms_id}: expected 204, got {response.status_code}. \"\n                    f\"Response: {response.text}\"\n                )\nE               AssertionError:  Failed to delete 73ab5639-ba46-42aa-bb62-59755fd2379b: expected 204, got 502. Response: {\"fault\":{\"faultstring\":\"Unexpected EOF at target\",\"detail\":{\"errorcode\":\"messaging.adaptors.http.flow.UnexpectedEOFAtTarget\"}}}\nE               assert 502 == 204\nE                +  where 502 = <Response [502]>.status_code\n\nfeatures/conftest.py:101: AssertionError","steps":[],"attachments":[{"uid":"a4966ada77217e7d","name":"Step Passed: batch file is created for below data where mandatory field for site, location and unique uri values are invalid","source":"a4966ada77217e7d.txt","type":"text/plain","size":130},{"uid":"a4c4bd7bd64376c7","name":"Step Passed: batch file is uploaded in s3 bucket","source":"a4c4bd7bd64376c7.txt","type":"text/plain","size":54},{"uid":"2d7ffba9db6ee0b9","name":"Step Passed: file will be moved to destination bucket and inf ack file will be created","source":"2d7ffba9db6ee0b9.txt","type":"text/plain","size":92},{"uid":"c977cbb427ea690a","name":"Step Passed: inf ack file has success status for processed batch file","source":"c977cbb427ea690a.txt","type":"text/plain","size":75},{"uid":"4c788e06ab41c023","name":"Step Passed: bus ack file will be created","source":"4c788e06ab41c023.txt","type":"text/plain","size":47},{"uid":"ef45b172c740476b","name":"Step Passed: bus ack will not have any entry of successfully processed records","source":"ef45b172c740476b.txt","type":"text/plain","size":84},{"uid":"21fef78f68de0725","name":"Step Passed: Audit table will have correct status, queue name and record count for the processed batch file","source":"21fef78f68de0725.txt","type":"text/plain","size":113},{"uid":"59f776cb8d334ee1","name":"Step Passed: The imms event table will be populated with the correct data for 'created' event for records in batch file","source":"59f776cb8d334ee1.txt","type":"text/plain","size":125},{"uid":"9b8ae5bf758bfb56","name":"Step Passed: The delta table will be populated with the correct data for all created records in batch file","source":"9b8ae5bf758bfb56.txt","type":"text/plain","size":112},{"uid":"e258ad0ec2d4c357","name":"stdout","source":"e258ad0ec2d4c357.txt","type":"text/plain","size":11532}],"parameters":[],"stepsCount":0,"shouldDisplayMessage":true,"attachmentsCount":10,"hasContent":true,"attachmentStep":false},"afterStages":[],"labels":[{"name":"epic","value":"Immunization Service"},{"name":"suite","value":"Create the immunization event for a patient through batch file"},{"name":"feature","value":"Create the immunization event for a patient through batch file"},{"name":"tag","value":"vaccine_type_HIB"},{"name":"tag","value":"supplier_name_EMIS"},{"name":"tag","value":"functional"},{"name":"tag","value":"Create_Batch_Feature"},{"name":"tag","value":"delete_cleanup_batch"},{"name":"parentSuite","value":"features.batchTests.Steps"},{"name":"host","value":"runnervmi13qx"},{"name":"thread","value":"2537-MainThread"},{"name":"framework","value":"pytest"},{"name":"language","value":"cpython3"},{"name":"package","value":"features.batchTests.Steps.test_create_batch_steps"},{"name":"resultFormat","value":"allure2"}],"parameters":[],"links":[],"hidden":false,"retry":false,"extra":{"severity":"normal","retries":[],"categories":[{"name":"Product defects","matchedStatuses":[],"flaky":false}],"history":{"statistic":{"failed":1,"broken":0,"skipped":0,"passed":9,"unknown":0,"total":10},"items":[{"uid":"4041df49bd27d6a9","reportUrl":"https://NHSDigital.github.io/imms_fhir_api_automation/231/#testresult/4041df49bd27d6a9","status":"passed","time":{"start":1768394518998,"stop":1768394566079,"duration":47081}},{"uid":"f786cc3d469b5c28","reportUrl":"https://NHSDigital.github.io/imms_fhir_api_automation/230/#testresult/f786cc3d469b5c28","status":"passed","time":{"start":1768393363272,"stop":1768393413991,"duration":50719}},{"uid":"625e0e715dd3bf73","reportUrl":"https://NHSDigital.github.io/imms_fhir_api_automation/228/#testresult/625e0e715dd3bf73","status":"passed","time":{"start":1768302946606,"stop":1768302996872,"duration":50266}},{"uid":"e1ddbb451b672b0b","reportUrl":"https://NHSDigital.github.io/imms_fhir_api_automation/224/#testresult/e1ddbb451b672b0b","status":"passed","time":{"start":1768208699064,"stop":1768208756432,"duration":57368}},{"uid":"72fb10f7b24db6e6","reportUrl":"https://NHSDigital.github.io/imms_fhir_api_automation/220/#testresult/72fb10f7b24db6e6","status":"passed","time":{"start":1767954701532,"stop":1767954762237,"duration":60705}},{"uid":"9ac60a9768d60c01","reportUrl":"https://NHSDigital.github.io/imms_fhir_api_automation/218/#testresult/9ac60a9768d60c01","status":"passed","time":{"start":1767864088179,"stop":1767864144506,"duration":56327}},{"uid":"7733b390287ac545","reportUrl":"https://NHSDigital.github.io/imms_fhir_api_automation/215/#testresult/7733b390287ac545","status":"passed","time":{"start":1767713970361,"stop":1767714013029,"duration":42668}},{"uid":"b68c541e781acf36","reportUrl":"https://NHSDigital.github.io/imms_fhir_api_automation/213/#testresult/b68c541e781acf36","status":"passed","time":{"start":1767173559339,"stop":1767173604631,"duration":45292}},{"uid":"c24fd797d74d9505","reportUrl":"https://NHSDigital.github.io/imms_fhir_api_automation/210/#testresult/c24fd797d74d9505","status":"passed","time":{"start":1766482839912,"stop":1766482887178,"duration":47266}}]},"tags":["functional","vaccine_type_HIB","delete_cleanup_batch","Create_Batch_Feature","supplier_name_EMIS"]},"source":"49ba0ed797d1bf6e.json","parameterValues":[]}